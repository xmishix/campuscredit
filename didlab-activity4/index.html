<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DIDLab â€” ERC-20 DApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:0;background:#0b1320;color:#e6eaf2}
    .wrap{max-width:880px;margin:40px auto;padding:24px;border:1px solid #24314a;border-radius:14px;background:#0f1a2b}
    h1{margin:0 0 16px;font-size:22px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
    .row > *{flex:1}
    input,button{padding:10px 12px;border:1px solid #314164;background:#0b1527;color:#e6eaf2;border-radius:10px}
    button{cursor:pointer}
    button.primary{background:#335cff;border-color:#335cff}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .card{padding:12px;border:1px solid #24314a;border-radius:10px;background:#0b1527}
    .muted{opacity:.8}
    .ok{color:#7be07b}.warn{color:#ffd166}.err{color:#ff6b6b}
    .kvs{display:grid;grid-template-columns:180px 1fr;gap:8px}
    .kvs div{padding:6px 8px;border-bottom:1px dashed #22314e}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸš€ DIDLab â€” ERC-20 DApp</h1>

    <!-- CONFIG -->
    <div class="card">
      <div class="row">
        <div>
          <label>Token Address</label>
          <input id="tokenAddr" class="mono" value="0x49fd2be640db2910c2fab69bb8531ab6e76127ff"/>
        </div>
      </div>
      <div class="row">
        <button id="btnConnect" class="primary">1) Connect & Switch Network</button>
        <button id="btnLoad">2) Load Token</button>
        <button id="btnWatch">Add Token to MetaMask</button>
        <button id="btnRefresh">Refresh Balance</button>
      </div>
    </div>

    <!-- STATUS -->
    <div class="row">
      <div class="card">
        <div class="kvs">
          <div class="muted">Account</div><div id="acct" class="mono">â€”</div>
          <div class="muted">Network</div><div id="net" class="mono">â€”</div>
          <div class="muted">Token</div><div id="meta" class="mono">â€”</div>
          <div class="muted">Balance</div><div id="bal" class="mono">â€”</div>
        </div>
      </div>
    </div>

    <!-- TRANSFER -->
    <div class="card">
      <h3>Transfer</h3>
      <div class="row">
        <input id="to" class="mono" placeholder="Recipient 0x..." />
        <input id="amt" class="mono" placeholder="Amount (human units)" />
        <button id="btnSend" class="primary">Send</button>
      </div>
      <div id="txlog" class="mono muted"></div>
    </div>
    <p class="muted">Tip: import your private key into MetaMask to use this account.</p>
  </div>

  <script type="module">
    import {
      createPublicClient, createWalletClient, custom,
      getAddress, formatUnits, parseUnits
    } from "https://esm.sh/viem@2.37.5";

    const ERC20_ABI = [
      { type:"function", name:"name", stateMutability:"view", inputs:[], outputs:[{type:"string"}]},
      { type:"function", name:"symbol", stateMutability:"view", inputs:[], outputs:[{type:"string"}]},
      { type:"function", name:"decimals", stateMutability:"view", inputs:[], outputs:[{type:"uint8"}]},
      { type:"function", name:"balanceOf", stateMutability:"view", inputs:[{name:"account",type:"address"}], outputs:[{type:"uint256"}]},
      { type:"function", name:"transfer", stateMutability:"nonpayable", inputs:[{name:"to",type:"address"},{name:"amount",type:"uint256"}], outputs:[{type:"bool"}]},
      { type:"event", name:"Transfer", inputs:[
        {indexed:true, name:"from", type:"address"},
        {indexed:true, name:"to", type:"address"},
        {indexed:false, name:"value", type:"uint256"}
      ]},
    ];

    const TEAM_CHAIN = {
      id: 31339,
      name: "DIDLab Team 03",
      rpc: "https://hh-03.didlab.org"
    };

    const el = (id)=>document.getElementById(id);
    const tokenInput = el("tokenAddr");
    const acctEl = el("acct"), netEl = el("net"), metaEl = el("meta"), balEl = el("bal");
    const txlog = el("txlog");

    let token, decimals=18, symbol="ETH", name="Ethereum";
    let walletClient, publicClient, account;

    function hexChainId(id){ return "0x"+id.toString(16); }
    async function ensureMetamask() {
      if (!window.ethereum) throw new Error("MetaMask not found");
    }
    async function addOrSwitchNetwork() {
      const params = [{
        chainId: hexChainId(TEAM_CHAIN.id),
        chainName: TEAM_CHAIN.name,
        rpcUrls: [TEAM_CHAIN.rpc],
        nativeCurrency: { name:"ETH", symbol:"ETH", decimals:18 }
      }];
      try {
        await window.ethereum.request({ method: "wallet_switchEthereumChain", params:[{ chainId: params[0].chainId }] });
      } catch (e) {
        await window.ethereum.request({ method: "wallet_addEthereumChain", params });
      }
    }
    async function connect() {
      await ensureMetamask();
      const chain = {
        id: TEAM_CHAIN.id,
        name: TEAM_CHAIN.name,
        nativeCurrency: { name:"ETH", symbol:"ETH", decimals:18 },
        rpcUrls: { default: { http: [TEAM_CHAIN.rpc] } }
      };
      walletClient = createWalletClient({ chain, transport: custom(window.ethereum) });
      publicClient = createPublicClient({ chain, transport: custom(window.ethereum) });
      await addOrSwitchNetwork();
      const addrs = await window.ethereum.request({ method: "eth_requestAccounts" });
      account = getAddress(addrs[0]);
      acctEl.textContent = account;
      netEl.textContent = `${chain.name} (#${chain.id})`;
      logOk("Connected. Network ready.");
    }
    async function loadToken() {
      token = getAddress(tokenInput.value.trim());
      name = await publicClient.readContract({ address: token, abi: ERC20_ABI, functionName:"name" });
      symbol = await publicClient.readContract({ address: token, abi: ERC20_ABI, functionName:"symbol" });
      decimals = await publicClient.readContract({ address: token, abi: ERC20_ABI, functionName:"decimals" });
      metaEl.textContent = `${name} (${symbol}), ${decimals}d, ${token}`;
      logOk(`Loaded token ${symbol}`);
      publicClient.watchContractEvent({
        address: token, abi: ERC20_ABI, eventName: "Transfer",
        onLogs: (logs)=>{
          for (const l of logs) {
            if (l.args.from?.toLowerCase()===account.toLowerCase() || l.args.to?.toLowerCase()===account.toLowerCase()) {
              refresh();
              break;
            }
          }
        }
      });
      await refresh();
    }
    async function refresh() {
      if (!token || !account) return;
      const bal = await publicClient.readContract({
        address: token, abi: ERC20_ABI, functionName:"balanceOf", args: [account]
      });
      balEl.textContent = `${formatUnits(bal, Number(decimals))} ${symbol}`;
    }
    async function send() {
      const to = getAddress(el("to").value.trim());
      const amtStr = el("amt").value.trim();
      if (!amtStr) throw new Error("Enter amount");
      const amount = parseUnits(amtStr, Number(decimals));
      const hash = await walletClient.writeContract({
        address: token, abi: ERC20_ABI, functionName: "transfer",
        args: [to, amount],
        maxPriorityFeePerGas: 2_000_000_000n,
        maxFeePerGas: 21_000_000_000n,
        account
      });
      logWarn(`Submitted: ${hash}`);
      const rcpt = await publicClient.waitForTransactionReceipt({ hash });
      logOk(`Mined in block ${rcpt.blockNumber} (gas ${rcpt.gasUsed})`);
    }
    async function watchAsset() {
      if (!token || !symbol) return;
      await window.ethereum.request({
        method: "wallet_watchAsset",
        params: { type: "ERC20", options: { address: token, symbol, decimals:Number(decimals) } }
      });
      logOk("Token added to MetaMask (or already present).");
    }

    function logOk(m){ txlog.innerHTML = `<div class="ok">${escapeHtml(m)}</div>` + txlog.innerHTML; }
    function logWarn(m){ txlog.innerHTML = `<div class="warn">${escapeHtml(m)}</div>` + txlog.innerHTML; }
    function logErr(m){ txlog.innerHTML = `<div class="err">${escapeHtml(m)}</div>` + txlog.innerHTML; }
    function escapeHtml(s){ return s.replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

    el("btnConnect").onclick = async ()=>{ try{ await connect(); } catch(e){ logErr(e.message||e);} };
    el("btnLoad").onclick = async ()=>{ try{ await loadToken(); } catch(e){ logErr(e.message||e);} };
    el("btnRefresh").onclick = async ()=>{ try{ await refresh(); } catch(e){ logErr(e.message||e);} };
    el("btnSend").onclick = async ()=>{ try{ await send(); } catch(e){ logErr(e.shortMessage||e.message||e);} };
    el("btnWatch").onclick = async ()=>{ try{ await watchAsset(); } catch(e){ logErr(e.message||e);} };

    (()=>{
      if (tokenInput.value) metaEl.textContent = `Ready to load ${tokenInput.value}`;
    })();
  </script>
</body>
</html>

